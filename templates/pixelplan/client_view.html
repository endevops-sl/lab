{% extends "partials/base.html" %}
{% load static %}
{% block html %}data-layout="horizontal" data-layout-style="" data-layout-position="fixed"  data-topbar="light"{% endblock html %}
{% block title %}Client Profile{% endblock title %}
{% block extra_css %}
    <!--datatable css-->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" />
    <!--datatable responsive css-->
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap.min.css" />

    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
{% endblock extra_css %}
{% block content %}
            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="main-content">

                <div class="page-content">
                    <div class="container-fluid">
    
                        <div class="position-relative mx-n4 mt-n4">
                            <div class="profile-wid-bg profile-setting-img">
                                <img src="{% static 'images/profile-bg.jpg' %}" class="profile-wid-img" alt="">
                                <div class="overlay-content">
                                    <div class="text-end p-3">
                                        <div class="p-0 ms-auto rounded-circle profile-photo-edit">
                                            <input id="profile-foreground-img-file-input" type="file"
                                                class="profile-foreground-img-file-input">
                                            <label for="profile-foreground-img-file-input"
                                                class="profile-photo-edit btn btn-light">
                                                <i class="ri-image-edit-line align-bottom me-1"></i> Change Cover
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <div class="row">
                            <div class="col-xxl-3">
                                <div class="card mt-n5">
                                    <div class="card-body p-4">
                                        <div class="text-center">
                                            <div class="profile-user position-relative d-inline-block mx-auto  mb-4">
                                                <img src="{% static 'images/users/avatar-1.jpg' %}"
                                                    class="rounded-circle avatar-xl img-thumbnail user-profile-image"
                                                    alt="user-profile-image">
                                                <div class="avatar-xs p-0 rounded-circle profile-photo-edit">
                                                    <input id="profile-img-file-input" type="file"
                                                        class="profile-img-file-input">
                                                    <label for="profile-img-file-input"
                                                        class="profile-photo-edit avatar-xs">
                                                        <span class="avatar-title rounded-circle bg-light text-body">
                                                            <i class="ri-camera-fill"></i>
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                            <h5 class="fs-16 mb-1">{{ client.name }}</h5>
                                            <p class="text-muted mb-0">{{ client.email }}</p>
                                        </div>
                                    </div>
                                </div>
                                <!--end card-->
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">Info</h5>
                                        <div class="table-responsive">
                                            <table class="table table-borderless mb-0">
                                                <tbody>
                                                    <tr>
                                                        <th class="ps-0" scope="row">Full Name :</th>
                                                        <td class="text-muted">{{ client.given_name }} {{ client.family_name }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th class="ps-0" scope="row">E-mail :</th>
                                                        <td class="text-muted">{{ client.email }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th class="ps-0" scope="row">Status :</th>
                                                        <td class="text-muted">{{ client.status }}</td>
                                                    </tr>
                                                    {% comment %} <tr>
                                                        <th class="ps-0" scope="row">Location :</th>
                                                        <td class="text-muted">California, United States
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th class="ps-0" scope="row">Joining Date</th>
                                                        <td class="text-muted">24 Nov 2021</td>
                                                    </tr> {% endcomment %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div><!-- end card body -->
                                </div><!-- end card -->
                                {% comment %} <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-4">
                                            <div class="flex-grow-1">
                                                <h5 class="card-title mb-0">Portfolio</h5>
                                            </div>
                                            <div class="flex-shrink-0">
                                                <a href="javascript:void(0);" class="badge bg-light text-primary fs-12"><i
                                                        class="ri-add-fill align-bottom me-1"></i> Add</a>
                                            </div>
                                        </div>
                                        <div class="mb-3 d-flex">
                                            <div class="avatar-xs d-block flex-shrink-0 me-3">
                                                <span class="avatar-title rounded-circle fs-16 bg-body  text-body ">
                                                    <i class="ri-github-fill"></i>
                                                </span>
                                            </div>
                                            <input type="email" class="form-control" id="gitUsername" placeholder="Username"
                                                value="@daveadame">
                                        </div>
                                        <div class="mb-3 d-flex">
                                            <div class="avatar-xs d-block flex-shrink-0 me-3">
                                                <span class="avatar-title rounded-circle fs-16 bg-primary">
                                                    <i class="ri-global-fill"></i>
                                                </span>
                                            </div>
                                            <input type="text" class="form-control" id="websiteInput"
                                                placeholder="www.example.com" value="www.velzon.com">
                                        </div>
                                        <div class="mb-3 d-flex">
                                            <div class="avatar-xs d-block flex-shrink-0 me-3">
                                                <span class="avatar-title rounded-circle fs-16 bg-success">
                                                    <i class="ri-dribbble-fill"></i>
                                                </span>
                                            </div>
                                            <input type="text" class="form-control" id="dribbleName" placeholder="Username"
                                                value="@dave_adame">
                                        </div>
                                        <div class="d-flex">
                                            <div class="avatar-xs d-block flex-shrink-0 me-3">
                                                <span class="avatar-title rounded-circle fs-16 bg-danger">
                                                    <i class="ri-pinterest-fill"></i>
                                                </span>
                                            </div>
                                            <input type="text" class="form-control" id="pinterestName"
                                                placeholder="Username" value="Advance Dave">
                                        </div>
                                    </div>
                                </div>
                                <!--end card--> {% endcomment %}
                            </div>
                            <!--end col-->
                            <div class="col-xxl-9">
                                <div class="card mt-xxl-n5">
                                    <div class="card-header">
                                        <ul class="nav nav-tabs-custom rounded card-header-tabs border-bottom-0"
                                            role="tablist">
                                            <li class="nav-item">
                                                <a class="nav-link active" data-bs-toggle="tab" href="#personalDetails"
                                                    role="tab">
                                                    <i class="fas fa-home"></i>
                                                    Personal Details
                                                </a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" data-bs-toggle="tab" href="#changePassword" role="tab">
                                                    <i class="far fa-user"></i>
                                                    Invoices
                                                </a>
                                            </li>
                                            {% comment %} <li class="nav-item">
                                                <a class="nav-link" data-bs-toggle="tab" href="#experience" role="tab">
                                                    <i class="far fa-envelope"></i>
                                                    Experience
                                                </a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" data-bs-toggle="tab" href="#privacy" role="tab">
                                                    <i class="far fa-envelope"></i>
                                                    Privacy Policy
                                                </a>
                                            </li> {% endcomment %}
                                        </ul>
                                        
                                    </div>
                                    <div class="card-body p-4">
                                        <div class="tab-content">
                                            <div class="tab-pane active" id="personalDetails" role="tabpanel">
                                                <form method="post" action="{% url 'pixelplan:update_client' client.id %}">
                                                    {% csrf_token %}
                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <div class="mb-3">
                                                                <label for="givenNameInput" class="form-label">Given Name</label>
                                                                <input type="text" class="form-control" id="givenNameInput" name="given_name" placeholder="Enter given name" value="{{ client.given_name }}">
                                                            </div>
                                                        </div>
                                                        <!--end col-->
                                                        <div class="col-lg-6">
                                                            <div class="mb-3">
                                                                <label for="familyNameInput" class="form-label">Family Name</label>
                                                                <input type="text" class="form-control" id="familyNameInput" name="family_name" placeholder="Enter family name" value="{{ client.family_name }}">
                                                            </div>
                                                        </div>
                                                        <!--end col-->
                                                        <div class="col-lg-6">
                                                            <div class="mb-3">
                                                                <label for="emailInput" class="form-label">Email Address</label>
                                                                <input type="email" class="form-control" id="emailInput" name="email" placeholder="Enter email" value="{{ client.email }}">
                                                            </div>
                                                        </div>
                                                        <!--end col-->
                                                        <div class="col-lg-6">
                                                            <div class="mb-3">
                                                                <label for="companyIdInput" class="form-label">Company ID</label>
                                                                <input type="text" class="form-control" id="companyIdInput" name="company_id" placeholder="Enter company ID" value="{{ client.company_id }}">
                                                            </div>
                                                        </div>
                                                        <!--end col-->
                                                        <!-- Add other fields here according to your Client model -->
                                                        <div class="col-lg-12">
                                                            <div class="hstack gap-2 justify-content-end">
                                                                <button type="submit" class="btn btn-secondary">Update</button>
                                                                <button type="button" class="btn btn-soft-danger">Cancel</button>
                                                            </div>
                                                        </div>
                                                        <!--end col-->
                                                    </div>
                                                    <!--end row-->
                                                </form>
                                            </div>
                                            <!--end tab-pane-->
                                            <div class="tab-pane" id="changePassword" role="tabpanel">
                                                <div class="card">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <h5 class="card-title mb-0">Invoices</h5>
                                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">
                                                            <i class="ri-add-line"></i>
                                                        </button>
                                                    </div>
                                                    <div class="card-body">
                                                        <table id="model-datatables" class="table table-bordered nowrap table-striped align-middle" style="width:100%">
                                                            <thead>
                                                                <tr>
                                                                    <th>ID</th>
                                                                    <th>Name</th>
                                                                    <th>Creator</th>
                                                                    <th>Status</th>
                                                                    <th>Sent On</th>
                                                                    <th>Action</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for invoice in invoices %}
                                                                <tr>
                                                                    <td>{{ invoice.id }}</td>
                                                                    <td>{{ invoice.name }}</td>
                                                                    <td>{{ invoice.creator }}</td>
                                                                    <td>{{ invoice.status }}</td>
                                                                    <td>{{ invoice.shared_on }}</td>             
                                                                    {% comment %} <td><span class="badge bg-danger">High</span></td> {% endcomment %}
                                                                    <td>
                                                                        <div class="dropdown d-inline-block">
                                                                            <button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                                <i class="ri-more-fill align-middle"></i>
                                                                            </button>
                                                                            <ul class="dropdown-menu dropdown-menu-end">
                                                                                <li><a href="#!" class="dropdown-item"><i class="ri-eye-fill align-bottom me-2 text-muted"></i> View</a></li>
                                                                               <!-- Your button within a loop to display all invoices -->
                                                                                <li>
                                                                                    <a class="dropdown-item edit-item-btn" href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#editInvoiceModal"
                                                                                    data-invoice-id="{{ invoice.id }}"
                                                                                    data-invoice-name="{{ invoice.name }}"
                                                                                    data-invoice-status="{{ invoice.status }}"
                                                                                    data-invoice-file="{{ invoice.file.url }}">
                                                                                    <i class="ri-pencil-fill align-bottom me-2 text-muted"></i> Edit
                                                                                    </a>
                                                                                </li>
                                                                                <li>
                                                                                    <a class="dropdown-item remove-item-btn"  data-bs-toggle="modal" data-bs-target="#deleteInvoiceModal-{{ invoice.id }}">
                                                                                        <i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> Delete
                                                                                    </a>
                                                                                </li>
                                                                            </ul>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}            
                                                            </tbody>
                                                        </table>
                                                        <!-- Add Invoice Modal -->
                                                        <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
                                                            <div class="modal-dialog">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title" id="addInvoiceModalLabel">Add New Invoice</h5>
                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <!-- Form for creating a new invoice. Adjust action URL as needed. -->
                                                                        <form method="post" action="{% url 'pixelplan:create_invoice' client.pk %}" enctype="multipart/form-data">
                                                                            {% csrf_token %}
                                                                            <div class="mb-3">
                                                                                <label for="invoiceName" class="form-label">Invoice Name</label>
                                                                                <input type="text" class="form-control" id="invoiceName" name="name" required>
                                                                            </div>
                                                                            <div class="mb-3">
                                                                                <label for="invoiceStatus" class="form-label">Status</label>
                                                                                <select class="form-select" id="invoiceStatus" name="status" required>
                                                                                    <option value="Pending">Pending</option>
                                                                                    <option value="Paid">Paid</option>
                                                                                    <option value="Cancelled">Cancelled</option>
                                                                                </select>
                                                                            </div>
                                                                            <!-- This hidden field sets the current client as the default without listing other clients -->
                                                                            <input type="hidden" name="client" value="{{ client.pk }}">
                                                                            <div class="mb-3">
                                                                                <label for="invoiceFile" class="form-label">Invoice File</label>
                                                                                <input type="file" class="form-control" id="invoiceFile" name="file" required>
                                                                            </div>
                                                                            <div class="modal-footer">
                                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                                <button type="submit" class="btn btn-primary">Add Invoice</button>
                                                                            </div>
                                                                        </form>                                                                       
                                                                        
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Edit Invoice Modal -->
                                                        <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-hidden="true">
                                                            <div class="modal-dialog">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title">Edit Invoice</h5>
                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </div>
                                                                    <form id="editInvoiceForm" method="post" action="">
                                                                        <div class="modal-body">
                                                                            <!-- CSRF Token -->
                                                                            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                                            <div class="mb-3">
                                                                                <label for="invoiceName" class="form-label">Invoice Name</label>
                                                                                <input type="text" class="form-control" id="invoiceName" name="name" required>
                                                                            </div>
                                                                            <div class="mb-3">
                                                                                <label for="invoiceStatus" class="form-label">Status</label>
                                                                                <select class="form-select" id="invoiceStatus" name="status" required>
                                                                                    <option value="Pending">Pending</option>
                                                                                    <option value="Paid">Paid</option>
                                                                                    <option value="Cancelled">Cancelled</option>
                                                                                </select>
                                                                            </div>
                                                                            <div class="mb-3">
                                                                                <label for="invoiceFile" class="form-label">Invoice File</label>
                                                                                <input type="file" class="form-control" id="invoiceFile" name="file">
                                                                            </div>
                                                                        </div>
                                                                        <div class="modal-footer">
                                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                            <button type="submit" class="btn btn-primary">Save changes</button>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>



                                                        <!-- Delete Invoice Modal -->
                                                        {% comment %} <div class="modal fade" id="deleteInvoiceModal-{{ invoice.id }}" tabindex="-1" aria-labelledby="deleteInvoiceModalLabel-{{ invoice.id }}" aria-hidden="true">
                                                            <div class="modal-dialog">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title" id="deleteInvoiceModalLabel-{{ invoice.id }}">Delete Invoice</h5>
                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        Are you sure you want to delete this invoice?
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                        <a href="{% url 'pixelplan:delete_invoice' invoice.id %}" class="btn btn-danger">Delete</a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div> {% endcomment %}

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--end col-->
                        </div>
                        <!--end row-->
    
                    </div>
                    <!-- container-fluid -->
                </div><!-- End Page-content -->

            {% block footer %}
            {% include "partials/footer.html" %}
            {% endblock footer %}
            </div>
            <!-- end main content-->
{% endblock content %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<!--datatable js-->
<script src="{% static 'js/pages/profile-setting.init.js'%}"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

<script src="{% static 'js/pages/datatables.init.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% comment %} <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.edit-item-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const invoiceId = this.getAttribute('data-invoice-id');
                const invoiceName = this.getAttribute('data-invoice-name');
                const invoiceStatus = this.getAttribute('data-invoice-status');
                // Assuming you have a field for the invoice file, though handling file inputs might need more customization
                const invoiceFileUrl = this.getAttribute('data-invoice-file');
    
                // Now, pre-fill the modal's form fields
                const modal = document.querySelector('#editInvoiceModal');
                modal.querySelector('#invoiceName').value = invoiceName;
                modal.querySelector('#invoiceStatus').value = invoiceStatus;
                // For displaying file, you might want to show a link to the current file and option to upload a new one
                // Example: modal.querySelector('#currentInvoiceFile').href = invoiceFileUrl;
    
                // Update the form action if necessary
                const form = modal.querySelector('#editInvoiceForm');
                form.action = `/invoices/${invoiceId}/edit/`; // Make sure this URL matches your URL patterns
            });
        });
    
        // Handle form submission (consider AJAX for a smoother UX)
        const editInvoiceForm = document.querySelector('#editInvoiceForm');
        editInvoiceForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent the default form submission
    
            // Fetch form data
            const formData = new FormData(this);
    
            // Send a POST request to update the invoice
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken // Ensure you're passing the CSRF token correctly
                },
            })
            .then(response => response.json())
            .then(data => {
                // Handle success response
                // Close modal, show success message, refresh the part of the page with the invoice details, etc.
                $('#editInvoiceModal').modal('hide');
                Swal.fire({
                    title: 'Success!',
                    text: 'Invoice updated successfully!',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    location.reload(); // Or better, dynamically update the invoice row in the table
                });
            })
            .catch(error => {
                // Handle error
                console.error('Error updating the invoice:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'There was an error updating the invoice.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
        });
    });  
           
</script> {% endcomment %}

<script>
    $(document).ready(function() {
        // Triggered when an edit button is clicked
        $('.edit-item-btn').click(function() {
            // Retrieve data attributes from the clicked button
            var invoiceId = $(this).data('invoice-id');
            var invoiceName = $(this).data('invoice-name');
            var invoiceStatus = $(this).data('invoice-status');
    
            // Pre-fill the modal's form fields with the current invoice details
            $('#editInvoiceModal #invoiceName').val(invoiceName);
            $('#editInvoiceModal #invoiceStatus').val(invoiceStatus);
    
            // Set the form's action attribute to the update URL for the selected invoice
            $('#editInvoiceModal form').attr('action', `/invoices/${invoiceId}/update/`);
    
            // Display the modal
            $('#editInvoiceModal').modal('show');
        });
    
        // Handle form submission within the modal
        $('#editInvoiceForm').on('submit', function(e) {
            e.preventDefault(); // Prevent default form submission behavior
    
            // Create a FormData object, capturing the form's current data
            var formData = new FormData(this);
    
            // AJAX request to submit the form data to the server
            $.ajax({
                type: 'POST',
                url: $(this).attr('action'), // URL from the form's action attribute
                data: formData,
                processData: false, // Don't process the files
                contentType: false, // Set content type to false as jQuery will tell the server its a query string request
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val() // Include CSRF token
                },
                success: function(response) {
                    // On success, hide the modal and show a success message
                    $('#editInvoiceModal').modal('hide');
                    Swal.fire({
                        title: 'Success!',
                        text: 'Invoice updated successfully!',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(function() {
                        // Reload the page to reflect the changes
                        location.reload();
                    });
                },
                error: function(xhr, status, error) {
                    // On failure, display an error message
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    Swal.fire({
                        title: 'Error!',
                        text: 'Failed to update invoice: ' + errorMessage,
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });
    });
    </script>
    
    
    
{% endblock extra_js %}